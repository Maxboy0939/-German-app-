<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  ğŸ”§ Config Ø®ÙˆØ¯Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø°Ø§Ø±                      â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
    apiKey: "AIzaSyDZ5Dp5c8wqVQrqPwAob1pM1VPvakGd_W0",
    authDomain: "german-app-e7d9c.firebaseapp.com",
    projectId: "german-app-e7d9c",
    storageBucket: "german-app-e7d9c.firebasestorage.app",
    messagingSenderId: "396305678669",
    appId: "1:396305678669:web:a63130ed963ed93db4f704"
};

// ===== Firebase Init =====
let db, auth, currentUser = null;
let firebaseReady = false;

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    firebaseReady = true;
    console.log('âœ… Firebase initialized');
} catch(e) {
    console.warn('âš ï¸ Firebase init error:', e);
}

// ===== LESSON DATA =====
const lektionInfo=[
    {num:1,icon:"ğŸ“—",title:"Lektion 1",subtitle:"Hallo! Ich bin Nicole"},
    {num:2,icon:"ğŸ“˜",title:"Lektion 2",subtitle:"Der Familienname ist MÃ¼ller"},
    {num:3,icon:"ğŸ“™",title:"Lektion 3",subtitle:"Das ist mein Bruder"},
    {num:4,icon:"ğŸ“•",title:"Lektion 4",subtitle:"Du hast einen Bruder?"},
    {num:5,icon:"ğŸ“’",title:"Lektion 5",subtitle:"Was ist das?"},
    {num:6,icon:"ğŸ““",title:"Lektion 6",subtitle:"Das ist kein CafÃ©"},
    {num:7,icon:"ğŸ“”",title:"Lektion 7",subtitle:"Ich bin Journalistin"},
    {num:8,icon:"ğŸ“—",title:"Lektion 8",subtitle:"Mein Tag"},
    {num:9,icon:"ğŸ“˜",title:"Lektion 9",subtitle:"Was mÃ¶chtest du?"},
    {num:10,icon:"ğŸ“™",title:"Lektion 10",subtitle:"Ich steige ein"},
    {num:11,icon:"ğŸ“•",title:"Lektion 11",subtitle:"Was hast du gemacht?"},
    {num:12,icon:"ğŸ“’",title:"Lektion 12",subtitle:"Was ist passiert?"}
];

const L={
1:{t:"Lektion 1: Hallo!",w:[{d:"Hallo",f:"Ø³Ù„Ø§Ù…"},{d:"Guten Morgen",f:"ØµØ¨Ø­ Ø¨Ø®ÛŒØ±"},{d:"TschÃ¼s",f:"Ø®Ø¯Ø§Ø­Ø§ÙØ¸"},{d:"ich",f:"Ù…Ù†"},{d:"du",f:"ØªÙˆ"},{d:"er",f:"Ø§Ùˆ (Ù…Ø±Ø¯)"},{d:"sie",f:"Ø§Ùˆ (Ø²Ù†)"},{d:"Sie",f:"Ø´Ù…Ø§"},{d:"heiÃŸen",f:"Ù†Ø§Ù… Ø¯Ø§Ø´ØªÙ†"},{d:"kommen",f:"Ø¢Ù…Ø¯Ù†"},{d:"wohnen",f:"Ø²Ù†Ø¯Ú¯ÛŒ Ú©Ø±Ø¯Ù†"},{d:"sprechen",f:"ØµØ­Ø¨Øª Ú©Ø±Ø¯Ù†"},{d:"sein",f:"Ø¨ÙˆØ¯Ù†"},{d:"der Name",f:"Ø§Ø³Ù…"},{d:"Deutschland",f:"Ø¢Ù„Ù…Ø§Ù†"},{d:"Deutsch",f:"Ø¢Ù„Ù…Ø§Ù†ÛŒ"},{d:"Ja",f:"Ø¨Ù„Ù‡"},{d:"Nein",f:"Ù†Ù‡"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û±",s:[{t:"ÙØ¹Ù„ sein",c:"",tb:"ich <span class='highlight'>bin</span>\ndu <span class='highlight'>bist</span>\ner/sie <span class='highlight'>ist</span>\nSie <span class='highlight'>sind</span>",ex:["Ich <b>bin</b> Nicole."]},{t:"ØµØ±Ù ÙØ¹Ù„",c:"",tb:"ich komm<span class='highlight'>e</span>\ndu komm<span class='highlight'>st</span>\ner komm<span class='highlight'>t</span>",ex:["Ich <b>komme</b> aus Iran."]}]},l:{t:"Ø¯Ø±Ø³ Û±",s:[{t:"ğŸ¯ Ù‡Ø¯Ù",c:"â€¢ Ù…Ø¹Ø±ÙÛŒ Ø®ÙˆØ¯\nâ€¢ Ø³Ù„Ø§Ù… Ùˆ Ø®Ø¯Ø§Ø­Ø§ÙØ¸ÛŒ"}]},e:[{s:"Ich ___ Nicole.",o:["bin","bist","ist","sind"],c:0,h:"Ù…Ù† Ù‡Ø³ØªÙ…",x:"ich bin"},{s:"Wie ___ du?",o:["heiÃŸen","heiÃŸt","heiÃŸe","heiÃŸst"],c:1,h:"Ø§Ø³Ù…ØªØŸ",x:"du heiÃŸt"},{s:"Ich ___ aus Iran.",o:["kommt","kommen","kommst","komme"],c:3,h:"",x:"ich komme"},{s:"Er ___ in Berlin.",o:["wohne","wohnst","wohnt","wohnen"],c:2,h:"",x:"er wohnt"},{s:"Du ___ Student.",o:["bin","bist","ist","sind"],c:1,h:"",x:"du bist"}],ge:[{s:"ich ___ (sein)",o:["bin","bist","ist","sind"],c:0,h:"",x:"ich bin"},{s:"du ___ (sein)",o:["bin","bist","ist","sind"],c:1,h:"",x:"du bist"},{s:"er ___ (sein)",o:["bin","bist","ist","sind"],c:2,h:"",x:"er ist"}]},
2:{t:"Lektion 2",w:[{d:"der Familienname",f:"Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ"},{d:"die Adresse",f:"Ø¢Ø¯Ø±Ø³"},{d:"buchstabieren",f:"Ù‡Ø¬ÛŒ Ú©Ø±Ø¯Ù†"},{d:"langsam",f:"Ø¢Ù‡Ø³ØªÙ‡"},{d:"bitte",f:"Ù„Ø·ÙØ§Ù‹"},{d:"danke",f:"Ù…Ù…Ù†ÙˆÙ†"},{d:"Entschuldigung",f:"Ø¨Ø¨Ø®Ø´ÛŒØ¯"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û²",s:[{t:"Ø§Ø¹Ø¯Ø§Ø¯",c:"",tb:"21=<span class='highlight'>ein</span>und<span class='highlight'>zwanzig</span>\n30=dreiÃŸig\n100=hundert",ex:["25=fÃ¼nfundzwanzig"]}]},l:{t:"Ø¯Ø±Ø³ Û²",s:[{t:"ğŸ¯",c:"â€¢ Ø§Ø¹Ø¯Ø§Ø¯ Û²Û°-Û±Û°Û°"}]},e:[{s:"25 = ___",o:["zweiundfÃ¼nfzig","fÃ¼nfundzwanzig","fÃ¼nfzehn","zwanzig"],c:1,h:"",x:"fÃ¼nfundzwanzig"},{s:"Bitte sprechen Sie ___.",o:["schnell","langsam","laut","gut"],c:1,h:"",x:"langsam"}],ge:[{s:"dreiÃŸig=___",o:["13","30","3","33"],c:1,h:"",x:"30"}]},
3:{t:"Lektion 3",w:[{d:"die Familie",f:"Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡"},{d:"der Vater",f:"Ù¾Ø¯Ø±"},{d:"die Mutter",f:"Ù…Ø§Ø¯Ø±"},{d:"der Bruder",f:"Ø¨Ø±Ø§Ø¯Ø±"},{d:"die Schwester",f:"Ø®ÙˆØ§Ù‡Ø±"},{d:"verheiratet",f:"Ù…ØªØ£Ù‡Ù„"},{d:"ledig",f:"Ù…Ø¬Ø±Ø¯"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û³",s:[{t:"Ø¶Ù…Ø§ÛŒØ± Ù…Ù„Ú©ÛŒ",c:"",tb:"<span class='highlight'>mein</span> Vater\n<span class='highlight'>meine</span> Mutter",ex:["mein Bruder"]}]},l:{t:"Ø¯Ø±Ø³ Û³",s:[{t:"ğŸ¯",c:"â€¢ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡"}]},e:[{s:"Das ist ___ Bruder.(Ù…Ù†)",o:["mein","meine","dein","deine"],c:0,h:"Ù…Ø°Ú©Ø±",x:"mein"},{s:"Wie alt ___ du?",o:["bin","bist","ist","sind"],c:1,h:"",x:"bist"}],ge:[{s:"der Vaterâ†’___(Ù…Ù†)",o:["mein","meine","meinen","meinem"],c:0,h:"",x:"mein"}]},
4:{t:"Lektion 4",w:[{d:"haben",f:"Ø¯Ø§Ø´ØªÙ†"},{d:"der Hund",f:"Ø³Ú¯"},{d:"die Katze",f:"Ú¯Ø±Ø¨Ù‡"},{d:"schÃ¶n",f:"Ø²ÛŒØ¨Ø§"},{d:"ein/eine",f:"ÛŒÚ©"},{d:"kein/keine",f:"Ù‡ÛŒÚ†"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û´",s:[{t:"haben",c:"",tb:"ich <span class='highlight'>habe</span>\ndu <span class='highlight'>hast</span>\ner <span class='highlight'>hat</span>",ex:["Ich habe einen Bruder."]}]},l:{t:"Ø¯Ø±Ø³ Û´",s:[{t:"ğŸ¯",c:"â€¢ haben\nâ€¢ Ø§Ú©ÙˆØ²Ø§ØªÛŒÙˆ"}]},e:[{s:"Ich ___ einen Bruder.",o:["habe","hast","hat","haben"],c:0,h:"",x:"ich habe"},{s:"Ich habe ___ Hund.",o:["ein","eine","einen","einer"],c:2,h:"derâ†’einen",x:"einen"}],ge:[{s:"ich ___(haben)",o:["habe","hast","hat","haben"],c:0,h:"",x:"habe"}]},
5:{t:"Lektion 5",w:[{d:"der Tisch",f:"Ù…ÛŒØ²"},{d:"die Lampe",f:"Ù„Ø§Ù…Ù¾"},{d:"das Buch",f:"Ú©ØªØ§Ø¨"},{d:"neu",f:"Ù†Ùˆ"},{d:"kaputt",f:"Ø®Ø±Ø§Ø¨"},{d:"teuer",f:"Ú¯Ø±Ø§Ù†"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Ûµ",s:[{t:"Ø¢Ø±ØªÛŒÚ©Ù„",c:"",tb:"<span class='highlight'>der</span> Tisch\n<span class='highlight'>die</span> Lampe\n<span class='highlight'>das</span> Buch",ex:["Der Tisch ist groÃŸ."]}]},l:{t:"Ø¯Ø±Ø³ Ûµ",s:[{t:"ğŸ¯",c:"â€¢ der/die/das"}]},e:[{s:"___ Tisch ist groÃŸ.",o:["Der","Die","Das","Den"],c:0,h:"",x:"Der"},{s:"___ Buch ist gut.",o:["Der","Die","Das","Den"],c:2,h:"",x:"Das"}],ge:[{s:"derâ†’___",o:["ein","eine","einen","einer"],c:0,h:"",x:"ein"}]},
6:{t:"Lektion 6",w:[{d:"das CafÃ©",f:"Ú©Ø§ÙÙ‡"},{d:"der Supermarkt",f:"Ø³ÙˆÙ¾Ø±Ù…Ø§Ø±Ú©Øª"},{d:"die Bank",f:"Ø¨Ø§Ù†Ú©"},{d:"hier",f:"Ø§ÛŒÙ†Ø¬Ø§"},{d:"dort",f:"Ø¢Ù†Ø¬Ø§"},{d:"links",f:"Ú†Ù¾"},{d:"rechts",f:"Ø±Ø§Ø³Øª"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û¶",s:[{t:"Es gibt",c:"",tb:"Es gibt <span class='highlight'>einen</span> Supermarkt.",ex:["Hier gibt es ein CafÃ©."]}]},l:{t:"Ø¯Ø±Ø³ Û¶",s:[{t:"ğŸ¯",c:"â€¢ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§"}]},e:[{s:"Das ist ___ CafÃ©.(Ù†ÙÛŒ)",o:["kein","keine","keinen","keiner"],c:0,h:"",x:"kein"},{s:"Wo ___ der Bahnhof?",o:["bin","bist","ist","sind"],c:2,h:"",x:"ist"}],ge:[{s:"ein CafÃ©â†’___(Ù†ÙÛŒ)",o:["kein","keine","keinen","nicht"],c:0,h:"",x:"kein"}]},
7:{t:"Lektion 7",w:[{d:"der Beruf",f:"Ø´ØºÙ„"},{d:"der Arzt",f:"Ø¯Ú©ØªØ±"},{d:"der Lehrer",f:"Ù…Ø¹Ù„Ù…"},{d:"arbeiten",f:"Ú©Ø§Ø± Ú©Ø±Ø¯Ù†"},{d:"bei",f:"Ù†Ø²Ø¯"},{d:"als",f:"Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù†"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û·",s:[{t:"Ø´ØºÙ„",c:"",tb:"Ich bin <span class='highlight'>Arzt</span>. âœ…",ex:["Ich bin Ingenieur."]}]},l:{t:"Ø¯Ø±Ø³ Û·",s:[{t:"ğŸ¯",c:"â€¢ Ø´ØºÙ„â€ŒÙ‡Ø§"}]},e:[{s:"Ich bin ___.",o:["Arzt","ein Arzt","der Arzt","einen Arzt"],c:0,h:"",x:"Arzt"},{s:"Er arbeitet ___ BMW.",o:["in","bei","als","mit"],c:1,h:"",x:"bei"}],ge:[{s:"Lehrerâ†’die ___",o:["Lehrerin","Lehrerein","Lehrern","Lehrin"],c:0,h:"",x:"Lehrerin"}]},
8:{t:"Lektion 8",w:[{d:"aufstehen",f:"Ø¨Ù„Ù†Ø¯ Ø´Ø¯Ù†"},{d:"frÃ¼hstÃ¼cken",f:"ØµØ¨Ø­Ø§Ù†Ù‡"},{d:"einkaufen",f:"Ø®Ø±ÛŒØ¯"},{d:"kochen",f:"Ø¢Ø´Ù¾Ø²ÛŒ"},{d:"schlafen",f:"Ø®ÙˆØ§Ø¨ÛŒØ¯Ù†"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û¸",s:[{t:"ÙØ¹Ù„ Ø¬Ø¯Ø§Ø´Ø¯Ù†ÛŒ",c:"",tb:"<span class='highlight'>auf</span>stehenâ†’ich <span class='highlight'>stehe</span>...<span class='highlight'>auf</span>",ex:["Ich stehe um 7 auf."]}]},l:{t:"Ø¯Ø±Ø³ Û¸",s:[{t:"ğŸ¯",c:"â€¢ ÙØ¹Ù„ Ø¬Ø¯Ø§Ø´Ø¯Ù†ÛŒ"}]},e:[{s:"Ich ___ um 7 ___.(aufstehen)",o:["stehe...auf","aufstehe","stehe...ein","kaufe...auf"],c:0,h:"",x:"stehe...auf"},{s:"7:30=___",o:["halb sieben","halb acht","sieben Uhr","acht Uhr"],c:1,h:"âš ï¸",x:"halb acht"}],ge:[{s:"aufstehenâ†’ich___",o:["stehe...auf","aufstehe","stehauf","steheauf"],c:0,h:"",x:"stehe...auf"}]},
9:{t:"Lektion 9",w:[{d:"mÃ¶chten",f:"Ø®ÙˆØ§Ø³ØªÙ†"},{d:"essen",f:"Ø®ÙˆØ±Ø¯Ù†"},{d:"trinken",f:"Ù†ÙˆØ´ÛŒØ¯Ù†"},{d:"der Kaffee",f:"Ù‚Ù‡ÙˆÙ‡"},{d:"das Wasser",f:"Ø¢Ø¨"},{d:"lecker",f:"Ø®ÙˆØ´Ù…Ø²Ù‡"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û¹",s:[{t:"mÃ¶chten",c:"",tb:"ich <span class='highlight'>mÃ¶chte</span>\ndu <span class='highlight'>mÃ¶chtest</span>",ex:["Ich mÃ¶chte Kaffee."]}]},l:{t:"Ø¯Ø±Ø³ Û¹",s:[{t:"ğŸ¯",c:"â€¢ Ø³ÙØ§Ø±Ø´ ØºØ°Ø§"}]},e:[{s:"Ich ___ einen Kaffee.",o:["mÃ¶chte","mÃ¶chtest","mÃ¶chten","mÃ¶chtet"],c:0,h:"",x:"mÃ¶chte"},{s:"Was ___ du?(essen)",o:["esst","esse","isst","essen"],c:2,h:"",x:"isst"}],ge:[{s:"ich ___(mÃ¶chten)",o:["mÃ¶chte","mÃ¶chtest","mÃ¶chten","mÃ¶chtet"],c:0,h:"",x:"mÃ¶chte"}]},
10:{t:"Lektion 10",w:[{d:"die U-Bahn",f:"Ù…ØªØ±Ùˆ"},{d:"der Bus",f:"Ø§ØªÙˆØ¨ÙˆØ³"},{d:"das Auto",f:"Ù…Ø§Ø´ÛŒÙ†"},{d:"fahren",f:"Ø±ÙØªÙ†"},{d:"einsteigen",f:"Ø³ÙˆØ§Ø± Ø´Ø¯Ù†"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û±Û°",s:[{t:"mit+Ø¯Ø§ØªÛŒÙˆ",c:"",tb:"mit <span class='highlight'>dem</span> Bus\nmit <span class='highlight'>der</span> U-Bahn",ex:["Ich fahre mit dem Bus."]}]},l:{t:"Ø¯Ø±Ø³ Û±Û°",s:[{t:"ğŸ¯",c:"â€¢ Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„"}]},e:[{s:"Ich ___ mit der U-Bahn.",o:["fahre","fÃ¤hrst","fÃ¤hrt","fahren"],c:0,h:"",x:"fahre"},{s:"mit ___ Bus",o:["der","dem","den","die"],c:1,h:"Ø¯Ø§ØªÛŒÙˆ",x:"dem"}],ge:[{s:"ich ___(fahren)",o:["fahre","fÃ¤hrst","fÃ¤hrt","fahren"],c:0,h:"",x:"fahre"}]},
11:{t:"Lektion 11",w:[{d:"gemacht",f:"Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯Ù‡"},{d:"gekauft",f:"Ø®Ø±ÛŒØ¯Ù‡"},{d:"gegessen",f:"Ø®ÙˆØ±Ø¯Ù‡"},{d:"getrunken",f:"Ù†ÙˆØ´ÛŒØ¯Ù‡"},{d:"gefahren",f:"Ø±ÙØªÙ‡"},{d:"heute",f:"Ø§Ù…Ø±ÙˆØ²"},{d:"gestern",f:"Ø¯ÛŒØ±ÙˆØ²"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û±Û±",s:[{t:"Perfekt",c:"",tb:"Ich <span class='highlight'>habe</span> <span class='highlight'>getrunken</span>.\nSie <span class='highlight'>ist</span> <span class='highlight'>gefahren</span>.",ex:["Ich habe gelernt."]}]},l:{t:"Ø¯Ø±Ø³ Û±Û±",s:[{t:"ğŸ¯",c:"â€¢ Ø²Ù…Ø§Ù† Ú¯Ø°Ø´ØªÙ‡"}]},e:[{s:"Ich ___ Kaffee getrunken.",o:["habe","bin","hat","ist"],c:0,h:"",x:"habe"},{s:"Sie ___ gefahren.",o:["habe","hat","bin","ist"],c:3,h:"sein",x:"ist"},{s:"machenâ†’___",o:["gemacht","gemachen","gemakt","macht"],c:0,h:"",x:"gemacht"}],ge:[{s:"lernenâ†’___",o:["gelernt","gelearnt","lernt","gelarnt"],c:0,h:"",x:"gelernt"}]},
12:{t:"Lektion 12",w:[{d:"passieren",f:"Ø§ØªÙØ§Ù‚ Ø§ÙØªØ§Ø¯Ù†"},{d:"der Kopf",f:"Ø³Ø±"},{d:"das Fieber",f:"ØªØ¨"},{d:"krank",f:"Ù…Ø±ÛŒØ¶"},{d:"wehtun",f:"Ø¯Ø±Ø¯ Ú©Ø±Ø¯Ù†"},{d:"mÃ¼ssen",f:"Ø¨Ø§ÛŒØ¯"},{d:"die Medizin",f:"Ø¯Ø§Ø±Ùˆ"}],g:{t:"Ú¯Ø±Ø§Ù…Ø± Û±Û²",s:[{t:"mÃ¼ssen",c:"",tb:"ich <span class='highlight'>muss</span>\ndu <span class='highlight'>musst</span>",ex:["Ich muss zum Arzt."]}]},l:{t:"Ø¯Ø±Ø³ Û±Û²",s:[{t:"ğŸ¯",c:"â€¢ Ø¨ÛŒÙ…Ø§Ø±ÛŒ"}]},e:[{s:"Mein Kopf ___ weh.",o:["tut","tust","macht","hat"],c:0,h:"",x:"tut"},{s:"Ich ___ zum Arzt.",o:["mÃ¼ssen","muss","musst","mÃ¼sst"],c:1,h:"",x:"muss"}],ge:[{s:"ich ___(mÃ¼ssen)",o:["muss","musst","mÃ¼ssen","mÃ¼sst"],c:0,h:"",x:"muss"}]}
};

// ===== STATE =====
let cL=1, cQ=[], cI=0, qS=0, cCI=0, cF=false;
let tS = parseInt(localStorage.getItem('ms')) || 0;
let st = parseInt(localStorage.getItem('mt')) || 0;
let settings = JSON.parse(localStorage.getItem('appSettings')) || {hints:true, autoNext:false};
let leaderboardCache = [];
let dataLoaded = false; // â­ NEW: Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² sync Ù‚Ø¨Ù„ Ø§Ø² load

// ===== UTILITIES =====
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

function trackDay() {
    let d = JSON.parse(localStorage.getItem('activeDays')) || [];
    const t = new Date().toISOString().split('T')[0];
    if (!d.includes(t)) {
        d.push(t);
        localStorage.setItem('activeDays', JSON.stringify(d));
    }
}

function getActiveDays() {
    return (JSON.parse(localStorage.getItem('activeDays')) || []).length;
}

trackDay();

function updateScoreUI() {
    document.getElementById('totalScore').textContent = tS;
    document.getElementById('streak').textContent = st;
    let l = 'Ù…Ø¨ØªØ¯ÛŒ';
    if (tS >= 500) l = 'â­ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ';
    else if (tS >= 300) l = 'ğŸ¥‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡';
    else if (tS >= 150) l = 'ğŸ¥ˆ Ù…ØªÙˆØ³Ø·';
    else if (tS >= 50) l = 'ğŸ¥‰ Ù…Ø¨ØªØ¯ÛŒ+';
    document.getElementById('levelBadge').textContent = l;
    localStorage.setItem('ms', tS);
    localStorage.setItem('mt', st);
}

// ===== TAB NAVIGATION =====
function switchTab(name, btn) {
    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('page' + name).classList.add('active');
    if (name === 'Home') {
        document.getElementById('headerTitle').textContent = 'ğŸ“š Menschen A1.1';
        document.getElementById('headerSub').textContent = 'Ø¢Ù…ÙˆØ²Ø´ Ø²Ø¨Ø§Ù† Ø¢Ù„Ù…Ø§Ù†ÛŒ';
    } else if (name === 'Leaderboard') {
        document.getElementById('headerTitle').textContent = 'ğŸ† Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ';
        document.getElementById('headerSub').textContent = 'Ø±Ù‚Ø§Ø¨Øª Ø¨Ø§ Ø¯ÛŒÚ¯Ø±Ø§Ù†';
        loadLeaderboard();
    } else if (name === 'Profile') {
        document.getElementById('headerTitle').textContent = 'ğŸ‘¤ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ';
        document.getElementById('headerSub').textContent = 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§';
        updateProfileUI();
    } else if (name === 'Settings') {
        document.getElementById('headerTitle').textContent = 'âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª';
        document.getElementById('headerSub').textContent = 'Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ';
        updateSettingsUI();
    }
}

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  â­ Ø¨Ø®Ø´ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡: Google Auth + Firestore Sync      â•‘
// â•‘  Ù…Ø´Ú©Ù„ Ù‚Ø¨Ù„ÛŒ: Ø§Ù…ØªÛŒØ§Ø² 0 Ù…ÛŒØ´Ø¯ Ú†ÙˆÙ† Ø§ÙˆÙ„ sync Ù…ÛŒÚ©Ø±Ø¯       â•‘
// â•‘  Ø­Ø§Ù„Ø§ Ø§ÙˆÙ„ Ø§Ø² Firestore Ù…ÛŒØ®ÙˆÙ†Ù‡ØŒ Ø¨Ø¹Ø¯ merge Ù…ÛŒÚ©Ù†Ù‡       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function googleSignIn() {
    if (!firebaseReady) {
        showToast('âš ï¸ Firebase ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡');
        return;
    }
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('profile');
    provider.addScope('email');

    // Ø§ÙˆÙ„ Popup Ø§Ù…ØªØ­Ø§Ù† Ù…ÛŒÚ©Ù†Ù‡ØŒ Ø§Ú¯Ù‡ Ù†Ø´Ø¯ Redirect
    auth.signInWithPopup(provider)
        .then(result => {
            currentUser = result.user;
            showToast('âœ… Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ' + (currentUser.displayName || ''));
            // â­ Ø§ÙˆÙ„ load Ù…ÛŒÚ©Ù†ÛŒÙ…ØŒ Ø¨Ø¹Ø¯ sync
            loadUserFromFirestore();
            updateProfileUI();
        })
        .catch(err => {
            console.error('Auth error:', err);
            if (err.code === 'auth/popup-blocked' ||
                err.code === 'auth/popup-closed-by-user' ||
                err.code === 'auth/cancelled-popup-request') {
                // Popup Ø¨Ø³ØªÙ‡ Ø´Ø¯ â†’ Redirect
                showToast('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„...');
                auth.signInWithRedirect(provider);
            } else if (err.code === 'auth/unauthorized-domain') {
                showToast('âš ï¸ Ø¯Ø§Ù…Ù†Ù‡ Ø³Ø§ÛŒØª Ø¨Ù‡ Firebase Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡!');
            } else {
                showToast('âŒ Ø®Ø·Ø§: ' + err.message);
            }
        });
}

function googleSignOut() {
    if (auth) {
        auth.signOut().then(() => {
            currentUser = null;
            dataLoaded = false;
            showToast('ğŸ‘‹ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯');
            updateProfileUI();
        });
    }
}

// â­â­â­ NEW: Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Firestore (Ø­Ù„ Ù…Ø´Ú©Ù„ score=0) â­â­â­
function loadUserFromFirestore() {
    if (!firebaseReady || !currentUser) return;

    console.log('ğŸ“¥ Loading data from Firestore...');

    db.collection('users').doc(currentUser.uid).get()
        .then(doc => {
            if (doc.exists) {
                const data = doc.data();
                console.log('ğŸ“¦ Firestore data:', data);

                // â­ Ù…Ù‚Ø§ÛŒØ³Ù‡: Ù‡Ø± Ú©Ø¯ÙˆÙ… Ø¨ÛŒØ´ØªØ±Ù‡ØŒ Ø§ÙˆÙ† Ø±Ùˆ Ù†Ú¯Ù‡ Ø¯Ø§Ø±
                const cloudScore = data.score || 0;
                const cloudStreak = data.streak || 0;

                if (cloudScore > tS) {
                    tS = cloudScore;
                    console.log('â˜ï¸ Cloud score is higher:', tS);
                }
                if (cloudStreak > st) {
                    st = cloudStreak;
                }

                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
                localStorage.setItem('ms', tS);
                localStorage.setItem('mt', st);
                updateScoreUI();
                updateProfileUI();
            }

            // Ø­Ø§Ù„Ø§ sync Ú©Ù† (Ù…Ù…Ú©Ù†Ù‡ local Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´Ù‡)
            dataLoaded = true;
            syncUserToFirestore();
        })
        .catch(err => {
            console.warn('âŒ Load error:', err);
            dataLoaded = true;
            syncUserToFirestore();
        });
}

// â­ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡: ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø² loadØŒ Ø§Ø¬Ø§Ø²Ù‡ sync Ø¨Ø¯Ù‡
function syncUserToFirestore() {
    if (!firebaseReady || !currentUser) return;
    if (!dataLoaded) {
        console.log('â³ Waiting for data load before sync...');
        return;
    }

    console.log('ğŸ“¤ Syncing to Firestore... score:', tS);

    const ref = db.collection('users').doc(currentUser.uid);
    ref.set({
        displayName: currentUser.displayName || 'Ú©Ø§Ø±Ø¨Ø±',
        photoURL: currentUser.photoURL || '',
        email: currentUser.email || '',
        score: tS,
        streak: st,
        level: tS >= 500 ? 'A1+' : tS >= 300 ? 'A1' : 'A1.1',
        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
        activeDays: getActiveDays(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true })
    .then(() => console.log('âœ… Synced successfully'))
    .catch(e => console.warn('âŒ Sync error:', e));
}

function updateScoreOnline() {
    updateScoreUI();
    syncUserToFirestore();
}

// â­ Auth State Listener
if (firebaseReady) {
    // Handle redirect result (for WebView / mobile)
    auth.getRedirectResult()
        .then(result => {
            if (result && result.user) {
                currentUser = result.user;
                showToast('âœ… Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ' + (result.user.displayName || ''));
                loadUserFromFirestore();
                updateProfileUI();
            }
        })
        .catch(err => console.warn('Redirect error:', err));

    // Listen for auth changes
    auth.onAuthStateChanged(user => {
        currentUser = user;
        if (user) {
            console.log('ğŸ‘¤ User signed in:', user.displayName);
            loadUserFromFirestore(); // â­ Ø§ÙˆÙ„ loadØŒ Ø¨Ø¹Ø¯ sync
            document.getElementById('connStatus').textContent = 'ğŸŸ¢ Ù…ØªØµÙ„';
        } else {
            console.log('ğŸ‘¤ User signed out');
            dataLoaded = false;
            document.getElementById('connStatus').textContent = 'ğŸ”´ Ø¢ÙÙ„Ø§ÛŒÙ†';
        }
        updateProfileUI();
    });
}

// ===== LEADERBOARD =====
function loadLeaderboard() {
    if (!firebaseReady) {
        document.getElementById('lbList').innerHTML =
            '<div class="loading-spinner" style="padding:30px">' +
            '<p style="font-size:0.85em;color:var(--text-secondary)">' +
            'âš ï¸ Firebase ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡</p></div>';
        document.getElementById('podiumArea').innerHTML = '';
        document.getElementById('onlineCount').textContent = 'Ø¢ÙÙ„Ø§ÛŒÙ†';
        return;
    }

    document.getElementById('lbList').innerHTML =
        '<div class="loading-spinner"><div class="spin">â³</div>' +
        '<p>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>';

    db.collection('users')
        .orderBy('score', 'desc')
        .limit(50)
        .get()
        .then(snapshot => {
            leaderboardCache = [];
            snapshot.forEach(doc => {
                leaderboardCache.push({ id: doc.id, ...doc.data() });
            });
            renderLeaderboard(leaderboardCache);
        })
        .catch(err => {
            console.error('Leaderboard error:', err);
            document.getElementById('lbList').innerHTML =
                '<div class="loading-spinner"><p>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p></div>';
        });

    const fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000);
    db.collection('users')
        .where('lastActive', '>', fiveMinAgo)
        .get()
        .then(snap => {
            document.getElementById('onlineCount').textContent =
                snap.size + ' Ù†ÙØ± Ø¢Ù†Ù„Ø§ÛŒÙ†';
        })
        .catch(() => {});
}

function renderLeaderboard(users) {
    if (!users || users.length === 0) {
        document.getElementById('podiumArea').innerHTML = '';
        document.getElementById('lbList').innerHTML =
            '<div class="loading-spinner"><p>Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡!</p></div>';
        return;
    }

    const top3 = users.slice(0, 3);
    const medals = ['ğŸ¥ˆ', 'ğŸ¥‡', 'ğŸ¥‰'];
    const classes = ['second', 'first', 'third'];
    const order = [1, 0, 2];
    let podiumHTML = '<div class="podium">';

    order.forEach((idx, dIdx) => {
        const u = top3[idx];
        if (!u) return;
        const isMe = currentUser && u.id === currentUser.uid;
        const name = u.displayName || 'Ú©Ø§Ø±Ø¨Ø±';
        const photo = u.photoURL;
        const avatarHTML = photo
            ? '<img src="' + photo + '" alt="">'
            : name.charAt(0).toUpperCase();

        podiumHTML +=
            '<div class="podium-item ' + classes[dIdx] + '">' +
            '<div class="podium-avatar"' + (isMe ? ' style="border-color:var(--accent-indigo)"' : '') + '>' +
            avatarHTML +
            '<div class="podium-medal">' + medals[idx] + '</div></div>' +
            '<div class="podium-name">' + (isMe ? 'Ø´Ù…Ø§' : name.split(' ')[0]) + '</div>' +
            '<div class="podium-score-text">' + (u.score || 0) + ' â­</div>' +
            '<div class="podium-bar"><span class="podium-rank">' + (idx + 1) + '</span></div></div>';
    });
    podiumHTML += '</div>';
    document.getElementById('podiumArea').innerHTML = podiumHTML;

    let listHTML = '';
    users.forEach((u, i) => {
        if (i < 3) return;
        const isMe = currentUser && u.id === currentUser.uid;
        const name = u.displayName || 'Ú©Ø§Ø±Ø¨Ø±';
        const photo = u.photoURL;
        const avatarHTML = photo
            ? '<img src="' + photo + '" alt="">'
            : '<span style="font-size:1.2em">' + name.charAt(0).toUpperCase() + '</span>';
        const lastActive = u.lastActive ? u.lastActive.toDate() : null;
        const isOnline = lastActive && (Date.now() - lastActive.getTime()) < 5 * 60 * 1000;

        listHTML +=
            '<div class="lb-item ' + (isMe ? 'is-me' : '') + '">' +
            '<div class="lb-rank">' + (i + 1) + '</div>' +
            '<div class="lb-avatar-sm"' + (isMe ? ' style="border-color:var(--accent-indigo)"' : '') + '>' +
            avatarHTML + '</div>' +
            '<div class="lb-info"><div class="lb-name">' +
            (isMe ? '<span class="me-badge">Ø´Ù…Ø§</span>' : '') + name + '</div>' +
            '<div class="lb-details">' + (isOnline ? 'ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'ğŸ”˜ Ø¢ÙÙ„Ø§ÛŒÙ†') +
            ' â€¢ Ø³Ø·Ø­ ' + (u.level || 'A1') + ' â€¢ ğŸ”¥' + (u.streak || 0) + '</div></div>' +
            '<div class="lb-score"><div class="lb-score-val">' + (u.score || 0) + '</div>' +
            '<div class="lb-score-label">Ø§Ù…ØªÛŒØ§Ø²</div></div></div>';
    });
    document.getElementById('lbList').innerHTML =
        listHTML || '<div class="loading-spinner"><p>Ù„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ</p></div>';
}

// ===== PROFILE UI =====
function updateProfileUI() {
    if (currentUser) {
        document.getElementById('authPrompt').style.display = 'none';
        document.getElementById('profileContent').style.display = 'block';
        document.getElementById('profileName').textContent = currentUser.displayName || 'Ú©Ø§Ø±Ø¨Ø±';
        document.getElementById('profileEmail').textContent = currentUser.email || '';

        const avatarEl = document.getElementById('profileAvatar');
        if (currentUser.photoURL) {
            avatarEl.innerHTML = '<img src="' + currentUser.photoURL + '" alt="">';
        } else {
            avatarEl.innerHTML = '<span class="avatar-letter">' +
                (currentUser.displayName || 'U').charAt(0).toUpperCase() + '</span>';
        }

        document.getElementById('pStatScore').textContent = tS;
        document.getElementById('pStatStreak').textContent = st;
        document.getElementById('pStatDays').textContent = getActiveDays();

        if (firebaseReady) {
            db.collection('users').where('score', '>', tS).get()
                .then(snap => {
                    document.getElementById('pStatRank').textContent = '#' + (snap.size + 1);
                })
                .catch(() => {
                    document.getElementById('pStatRank').textContent = '-';
                });
        }
    } else {
        document.getElementById('authPrompt').style.display = 'block';
        document.getElementById('profileContent').style.display = 'none';
    }
}

// ===== HOME NAVIGATION =====
function hideHomeContent() {
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('subMenu').classList.remove('show');
    document.getElementById('subMenuBack').style.display = 'none';
    ['wordsArea', 'grammarArea', 'lessonArea'].forEach(id =>
        document.getElementById(id).classList.remove('show'));
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('resultCard').style.display = 'none';
}

function goHome() {
    hideHomeContent();
    document.getElementById('mainMenu').style.display = 'block';
    document.getElementById('headerTitle').textContent = 'ğŸ“š Menschen A1.1';
    document.getElementById('headerSub').textContent = 'Ø¢Ù…ÙˆØ²Ø´ Ø²Ø¨Ø§Ù† Ø¢Ù„Ù…Ø§Ù†ÛŒ';
    updateScoreUI();
}

function openLektion(n) {
    cL = n;
    hideHomeContent();
    document.getElementById('subMenu').classList.add('show');
    document.getElementById('subMenuBack').style.display = 'block';
    document.getElementById('headerTitle').textContent = 'ğŸ“š ' + L[n].t;
    document.getElementById('headerSub').textContent = 'Ø¨Ø®Ø´ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†';
}

function backToSubMenu() {
    hideHomeContent();
    document.getElementById('subMenu').classList.add('show');
    document.getElementById('subMenuBack').style.display = 'block';
}

function showSection(t) {
    hideHomeContent();
    const l = L[cL];
    if (t === 'words') sW(l);
    else if (t === 'grammar') sG(l);
    else if (t === 'lesson') sL(l);
    else if (t === 'exercise') sEM(l);
}

// ===== WORDS =====
function sW(l) {
    const a = document.getElementById('wordsArea');
    let h = '<div class="card liquid-glass-lg"><h2>ğŸ“ ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§</h2>' +
        '<div class="flashcard" onclick="fWC()"><div class="word" id="wW"></div>' +
        '<div class="meaning" id="wM"></div><div class="tap-hint" id="wH">ğŸ‘† Ù„Ù…Ø³ Ú©Ù†</div></div>' +
        '<div class="fc-counter" id="wC"></div>' +
        '<div class="fc-nav"><button onclick="pWC()">â¬…ï¸</button><button onclick="nWC()">â¡ï¸</button></div></div>';
    h += '<div class="card liquid-glass-lg"><h2>ğŸ“‹ Ù„ÛŒØ³Øª</h2><table class="word-table"><tr><th>Ø¢Ù„Ù…Ø§Ù†ÛŒ</th><th>ÙØ§Ø±Ø³ÛŒ</th></tr>';
    l.w.forEach(w => {
        h += '<tr><td class="de">' + w.d + '</td><td class="fa">' + w.f + '</td></tr>';
    });
    h += '</table></div><button class="back-btn" onclick="backToSubMenu()">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª</button>';
    a.innerHTML = h;
    a.classList.add('show');
    cCI = 0;
    dWC(l);
}

function dWC(l) {
    if (!l) l = L[cL];
    const w = l.w[cCI];
    document.getElementById('wW').textContent = w.d;
    document.getElementById('wM').textContent = w.f;
    document.getElementById('wM').style.display = 'none';
    document.getElementById('wH').style.display = 'block';
    document.getElementById('wC').textContent = (cCI + 1) + ' / ' + l.w.length;
    cF = false;
}

function fWC() {
    const m = document.getElementById('wM'), h = document.getElementById('wH');
    if (!cF) { m.style.display = 'block'; h.style.display = 'none'; cF = true; }
    else { m.style.display = 'none'; h.style.display = 'block'; cF = false; }
}
function nWC() { cCI = (cCI + 1) % L[cL].w.length; dWC(L[cL]); }
function pWC() { cCI = (cCI - 1 + L[cL].w.length) % L[cL].w.length; dWC(L[cL]); }

// ===== GRAMMAR / LESSON =====
function sG(l) {
    const a = document.getElementById('grammarArea');
    let h = '';
    l.g.s.forEach(s => {
        h += '<div class="card liquid-glass-lg"><h3>' + s.t + '</h3>';
        if (s.c) h += '<p>' + s.c + '</p>';
        h += '<div class="grammar-box">' + s.tb.replace(/\n/g, '<br>') + '</div>';
        if (s.ex) { h += '<h3>Ù…Ø«Ø§Ù„:</h3><ul>'; s.ex.forEach(e => h += '<li>' + e + '</li>'); h += '</ul>'; }
        h += '</div>';
    });
    h += '<button class="back-btn" onclick="backToSubMenu()">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª</button>';
    a.innerHTML = h; a.classList.add('show');
}

function sL(l) {
    const a = document.getElementById('lessonArea');
    let h = '';
    l.l.s.forEach(s => {
        h += '<div class="card liquid-glass-lg"><h3>' + s.t + '</h3><p style="white-space:pre-line">' + s.c + '</p></div>';
    });
    h += '<button class="back-btn" onclick="backToSubMenu()">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª</button>';
    a.innerHTML = h; a.classList.add('show');
}

// ===== EXERCISE =====
function sEM(l) {
    const a = document.getElementById('wordsArea');
    let h = '<div class="card liquid-glass-lg"><h2>âœï¸ ØªÙ…Ø±ÛŒÙ†</h2></div>' +
        '<div class="sub-menu show" style="display:grid">' +
        '<div class="sub-btn liquid-glass" onclick="sE(\'m\')"><span class="sicon">âœï¸</span><span>ØªÙ…Ø±ÛŒÙ† Ø¯Ø±Ø³</span></div>' +
        '<div class="sub-btn liquid-glass" onclick="sE(\'g\')"><span class="sicon">ğŸ“</span><span>Ú¯Ø±Ø§Ù…Ø±</span></div>' +
        '<div class="sub-btn liquid-glass" onclick="sE(\'w\')"><span class="sicon">ğŸ”¤</span><span>Ù„ØºØ§Øª</span></div>' +
        '<div class="sub-btn liquid-glass" onclick="sE(\'a\')"><span class="sicon">ğŸ¯</span><span>Ø¢Ø²Ù…ÙˆÙ†</span></div></div>' +
        '<button class="back-btn" onclick="backToSubMenu()">â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª</button>';
    a.innerHTML = h; a.classList.add('show');
}

function sE(t) {
    hideHomeContent();
    const l = L[cL];
    let q = [];
    if (t === 'm') q = [...l.e];
    else if (t === 'g') q = [...(l.ge || [])];
    else if (t === 'w') {
        const w = [...l.w].sort(() => Math.random() - 0.5).slice(0, 6);
        w.forEach(wi => {
            const o = [wi.f];
            while (o.length < 4) {
                const r = l.w[Math.floor(Math.random() * l.w.length)].f;
                if (!o.includes(r)) o.push(r);
            }
            o.sort(() => Math.random() - 0.5);
            q.push({ s: wi.d + " = ___", o: o, c: o.indexOf(wi.f), h: "Ù…Ø¹Ù†ÛŒ", x: wi.d + "=" + wi.f });
        });
    } else q = [...l.e, ...(l.ge || [])].sort(() => Math.random() - 0.5);
    cQ = q.sort(() => Math.random() - 0.5);
    cI = 0; qS = 0;
    document.getElementById('quizArea').style.display = 'block';
    sQ();
}

function sQ() {
    if (cI >= cQ.length) { sR(); return; }
    const q = cQ[cI];
    document.getElementById('progressFill').style.width = (cI / cQ.length * 100) + '%';
    document.getElementById('questionNumber').textContent = 'Ø³Ø¤Ø§Ù„ ' + (cI + 1) + ' Ø§Ø² ' + cQ.length;
    document.getElementById('questionText').textContent = 'Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø±Ùˆ Ù¾Ø± Ú©Ù†:';
    document.getElementById('questionSentence').innerHTML =
        q.s.replace('___', '<span class="blank">______</span>');
    document.getElementById('questionHint').textContent =
        settings.hints && q.h ? 'ğŸ’¡ ' + q.h : '';
    const c = document.getElementById('optionsContainer');
    c.innerHTML = '';
    q.o.forEach((o, i) => {
        const b = document.createElement('button');
        b.className = 'option-btn';
        b.textContent = o;
        b.onclick = () => cA(i, b);
        c.appendChild(b);
    });
    document.getElementById('explanation').classList.remove('show');
    document.getElementById('nextBtn').classList.remove('show');
}

function cA(s, b) {
    const q = cQ[cI];
    const bs = document.querySelectorAll('.option-btn');
    bs.forEach(b => b.disabled = true);
    if (s === q.c) {
        b.classList.add('correct');
        qS++;
        tS += 10;
        st++;
    } else {
        b.classList.add('wrong');
        bs[q.c].classList.add('correct');
        st = 0;
    }
    document.getElementById('explanation').innerHTML = 'ğŸ“š ' + q.x;
    document.getElementById('explanation').classList.add('show');
    document.getElementById('nextBtn').classList.add('show');
    updateScoreOnline(); // â­ Ø­Ø§Ù„Ø§ Ø¯Ø±Ø³Øª sync Ù…ÛŒÚ©Ù†Ù‡
    if (settings.autoNext) setTimeout(() => nextQuestion(), 1500);
}

function nextQuestion() { cI++; sQ(); }

function sR() {
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('resultCard').style.display = 'block';
    const p = Math.round(qS / cQ.length * 100);
    let e, t, x;
    if (p === 100) { e = 'ğŸ†'; t = 'Ø¹Ø§Ù„ÛŒ!'; x = 'Ø¨ÛŒâ€ŒÙ†Ù‚Øµ!'; }
    else if (p >= 80) { e = 'ğŸŒŸ'; t = 'Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨!'; x = 'Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡!'; }
    else if (p >= 60) { e = 'ğŸ‘'; t = 'Ø®ÙˆØ¨ Ø¨ÙˆØ¯!'; x = 'ØªÙ…Ø±ÛŒÙ† Ú©Ù†!'; }
    else { e = 'ğŸ’ª'; t = 'Ù†Ø§Ø§Ù…ÛŒØ¯ Ù†Ø´Ùˆ!'; x = 'Ø¯Ø±Ø³ Ø±Ùˆ Ø¨Ø®ÙˆÙ†!'; }
    document.getElementById('resultEmoji').textContent = e;
    document.getElementById('resultTitle').textContent = t;
    document.getElementById('resultScore').textContent = qS + ' Ø§Ø² ' + cQ.length;
    document.getElementById('resultText').textContent = x;
    syncUserToFirestore();
}

// ===== SETTINGS =====
function updateSettingsUI() {
    const isDark = !document.body.classList.contains('light-mode');
    document.getElementById('themeToggle').classList.toggle('active', isDark);
    document.getElementById('hintToggle').classList.toggle('active', settings.hints);
    document.getElementById('autoNextToggle').classList.toggle('active', settings.autoNext);
}

function toggleTheme() {
    document.body.classList.toggle('light-mode');
    const isLight = document.body.classList.contains('light-mode');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    updateSettingsUI();
    showToast(isLight ? 'â˜€ï¸ Ø±ÙˆØ´Ù†' : 'ğŸŒ™ ØªØ§Ø±ÛŒÚ©');
}
function toggleHints() {
    settings.hints = !settings.hints;
    localStorage.setItem('appSettings', JSON.stringify(settings));
    updateSettingsUI();
}
function toggleAutoNext() {
    settings.autoNext = !settings.autoNext;
    localStorage.setItem('appSettings', JSON.stringify(settings));
    updateSettingsUI();
}
function resetProgress() {
    if (confirm('ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø¨Ø´Ù‡ØŸ')) {
        localStorage.removeItem('ms');
        localStorage.removeItem('mt');
        localStorage.removeItem('activeDays');
        tS = 0; st = 0;
        updateScoreUI();
        syncUserToFirestore();
        showToast('ğŸ—‘ï¸ Ù¾Ø§Ú© Ø´Ø¯!');
        goHome();
    }
}

function loadTheme() {
    if (localStorage.getItem('theme') === 'light')
        document.body.classList.add('light-mode');
}

// ===== BUILD =====
function buildList() {
    const li = document.getElementById('lektionList');
    let h = '';
    lektionInfo.forEach(l => {
        h += '<div class="lektion-btn liquid-glass" onclick="openLektion(' + l.num + ')">' +
            '<span class="icon">' + l.icon + '</span>' +
            '<div class="info"><div class="title">' + l.title + '</div>' +
            '<div class="subtitle">' + l.subtitle + '</div></div>' +
            '<span class="arrow">â†</span></div>';
    });
    li.innerHTML = h;
}

// Periodic sync
setInterval(() => {
    if (currentUser && dataLoaded) syncUserToFirestore();
}, 60000);

// ===== INIT =====
loadTheme();
buildList();
updateScoreUI();
</script>